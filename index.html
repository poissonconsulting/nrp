<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kootenay Lake Nutrient Restoration Program Data Loading • nrp</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Kootenay Lake Nutrient Restoration Program Data Loading">
<meta property="og:description" content="Imports CTD and EMS data for 
    the Kootenay Lake Nutrient Restoration Program (NRP) and uploads it to to a SQLite database.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">nrp</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0.9004</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">


<div id="nrp" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#nrp" class="anchor"></a>nrp</h1></div>
<p><code>nrp</code> is an R package developed for the Nutrient Restoration Program (NRP). It currently provides the following functionality for CTD and EMS data:</p>
<p><strong>Read in raw data files</strong><br> The package checks the validity of input data and does some cleaning and manipulation to make the data more informative and useful to the user.</p>
<p>For CTD data, the date and parameter units are extracted from the file meta data. The SiteID is pulled from the raw data filename, and validated by cross referencing it to known sites in the database.</p>
<p>For EMS data, the data is filtered to only include the parameters and sites of interest for the Nutrient Restoration Program. The data is then restructured in a ‘wide’ format that lends itself to easy analysis/plotting. During the process, parameters are assigned the correct units, and values that were measured as the detection limit are set to 0. Detection limit columns for each parameter are created to inform the user of the detection limit each time a 0 value is encountered. EMS metals and EMS standard are stored in separate tables in the database.</p>
<p><strong>Upload data to the NRP SQLite database</strong><br> When uploading new data to the database, the package checks to ensure that no duplicate data is present, and numerous checks are performed to ensure that the data’s structure is correct and compatible with the database.</p>
<p><strong>Download CTD data</strong><br> Data can then be downloaded from the database with optional filtering by SiteID, date range, etc.</p>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>To install the latest version from <a href="https://github.com/poissonconsulting/nrp" class="external-link">GitHub</a></p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages("remotes")</span>
<span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"poissonconsulting/nrp"</span><span class="op">)</span></code></pre></div>
</div>
<div id="demonstration" class="section level2">
<h2 class="hasAnchor">
<a href="#demonstration" class="anchor"></a>Demonstration</h2>
<p>For simplicity, this demonstration uses the function <code>nrp_create_db</code> to create an empty, temporary database to read and write to, and uses some test data that travels with the package. When connecting to a proper database, just provide the file path to the database for the argument <code>db_path</code> in all function calls and the connection will be made automatically. Alternatively you can connect to a database in R and then supply that connection object for the argument <code>db_path</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">nrp</span><span class="op">)</span>

<span class="co"># create empty database</span>
<span class="co"># path = ":memory:" creates a temporary, in memory database</span>
<span class="va">conn</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nrp_create_db.html">nrp_create_db</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">":memory:"</span><span class="op">)</span> 

<span class="co"># provide a path to a .cnv file</span>
<span class="va">path</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"ctd/2018/KL1_27Aug2018008downcast.cnv"</span>,
                       package <span class="op">=</span> <span class="st">"nrp"</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="co"># read in file</span>
<span class="va">ctd_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nrp_read_ctd_file.html">nrp_read_ctd_file</a></span><span class="op">(</span><span class="va">path</span>, db_path <span class="op">=</span> <span class="va">conn</span><span class="op">)</span>
<span class="co">#&gt; 32 negative depths removed from data</span>

<span class="co"># upload data to the database</span>
<span class="fu"><a href="reference/nrp_upload_ctd.html">nrp_upload_ctd</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ctd_data</span>, db_path <span class="op">=</span> <span class="va">conn</span><span class="op">)</span>
<span class="co">#&gt; 131 duplicate depths removed from data</span>

<span class="co"># download data from database, filtering by Date and SiteID and parameter</span>
<span class="va">db_ctd_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nrp_download_ctd.html">nrp_download_ctd</a></span><span class="op">(</span>start_date <span class="op">=</span> <span class="st">"2018-08-27"</span>,
                            end_date <span class="op">=</span> <span class="st">"2018-08-27"</span>,
                            sites <span class="op">=</span> <span class="st">"KL1"</span>,
                            parameters <span class="op">=</span> <span class="st">"all"</span>,
                            db_path <span class="op">=</span> <span class="va">conn</span><span class="op">)</span></code></pre></div>
<p>When updating EMS data, the user must supply their own data set which can be easily obtained using a function from the <code>rems</code> package: <code>get_ems_data(which = "4yr")</code>. The four year data set must be used as the two year data has different structure that does not contain all the parameters needed for use with nrp functions. Once you have the four year data set loaded in the environment, you can easily upload it to the database with nrp functions. You don’t have to worry about uploading duplicate data as the nrp function for uploading will automatically trim the input data so that only new data is added to the database. For this demonstration we use a light weight sample of raw EMS data that travels with the package.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># read in raw ems data</span>
<span class="va">path</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"ems/test_ems.rds"</span>, package <span class="op">=</span> <span class="st">"nrp"</span>, mustWork <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">ems_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span>

<span class="co"># extract into wide fromat that fits the nrp database, chooing either the</span>
<span class="co"># 'metals' or 'standard' analysis_type</span>
<span class="va">ems_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nrp_extract_ems.html">nrp_extract_ems</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ems_raw</span>, db_path <span class="op">=</span> <span class="va">conn</span>, analysis_type <span class="op">=</span> <span class="st">"standard"</span><span class="op">)</span>

<span class="co"># upload data to database</span>
<span class="fu"><a href="reference/nrp_upload_ems_standard.html">nrp_upload_ems_standard</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ems_data</span>, db_path <span class="op">=</span> <span class="va">conn</span><span class="op">)</span>

<span class="co"># download data from database, filtering by Date, SiteID, and analysis_type. </span>
<span class="co"># You can also choose to exlude detection limit columns</span>
<span class="va">db_ems_data_standard</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nrp_download_ems.html">nrp_download_ems</a></span><span class="op">(</span>start_date_time <span class="op">=</span> <span class="st">"2018-07-03 13:48:00"</span>,
                                     end_date_time <span class="op">=</span> <span class="st">"2018-07-31 13:28:00"</span>,
                                     sites <span class="op">=</span> <span class="cn">NULL</span>,
                                     db_path <span class="op">=</span> <span class="va">conn</span>,
                                     analysis_type <span class="op">=</span> <span class="st">"standard"</span>,
                                     show_detection_limits <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>There are additional functions in the nrp package that allow for easy downloading of other tables in the database.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Lakes and BasinArm tables</span>
<span class="va">lakes</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nrp_download_lakes.html">nrp_download_lakes</a></span><span class="op">(</span>db_path <span class="op">=</span> <span class="va">conn</span><span class="op">)</span>
<span class="va">basinArm</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nrp_download_ctd_basin_arm.html">nrp_download_ctd_basin_arm</a></span><span class="op">(</span>db_path <span class="op">=</span> <span class="va">conn</span><span class="op">)</span>

<span class="co"># site table</span>
<span class="va">sites</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nrp_download_sites.html">nrp_download_sites</a></span><span class="op">(</span>db_path <span class="op">=</span> <span class="va">conn</span><span class="op">)</span>

<span class="co"># ctd visit table</span>
<span class="va">ctd_visit</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nrp_download_ctd_visit.html">nrp_download_ctd_visit</a></span><span class="op">(</span>db_path <span class="op">=</span> <span class="va">conn</span><span class="op">)</span>

<span class="co"># Tip: the nrp functions can also use global options to automatically know</span>
<span class="co"># what database to connect to. Once you've set the global option "nrp.db_path"</span>
<span class="co"># for the database you want to connect to, you don't have to provide</span>
<span class="co"># the db_path argument any more within that R session</span>

<span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>nrp.db_path <span class="op">=</span> <span class="va">conn</span><span class="op">)</span> <span class="co"># "conn" can also be a file path to a database</span>

<span class="co"># now we can do things like:</span>
<span class="va">lakes</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/nrp_download_lakes.html">nrp_download_lakes</a></span><span class="op">(</span><span class="op">)</span>


<span class="co"># we conclude the demo by closing the database connection</span>
<span class="co"># If you are providing a file path to the database, you do not need to do this</span>
<span class="fu">readwritesqlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/readwritesqlite/man/rws_disconnect.html" class="external-link">rws_disconnect</a></span><span class="op">(</span><span class="va">conn</span><span class="op">)</span></code></pre></div>
</div>
<div id="getting-help-or-reporting-an-issue" class="section level2">
<h2 class="hasAnchor">
<a href="#getting-help-or-reporting-an-issue" class="anchor"></a>Getting Help or Reporting an Issue</h2>
<p>To report bugs/issues/feature requests, please file an <a href="https://github.com/poissonconsulting/nrp/issues/" class="external-link">issue</a>.</p>
</div>
<div id="how-to-contribute" class="section level2">
<h2 class="hasAnchor">
<a href="#how-to-contribute" class="anchor"></a>How to Contribute</h2>
<p>If you would like to contribute to the package, please see our <a href="CONTRIBUTING.html">CONTRIBUTING</a> guidelines.</p>
</div>
<div id="code-of-conduct" class="section level2">
<h2 class="hasAnchor">
<a href="#code-of-conduct" class="anchor"></a>Code of Conduct</h2>
<p>Please note that the nrp project is released with a <a href="https://contributor-covenant.org/version/2/0/CODE_OF_CONDUCT.html" class="external-link">Contributor Code of Conduct</a>. By contributing to this project, you agree to abide by its terms.</p>
</div>
<div id="license" class="section level2">
<h2 class="hasAnchor">
<a href="#license" class="anchor"></a>License</h2>
<p>The code is released under the Apache License 2.0</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>Copyright <span class="dv">2019</span> Province of British Columbia</span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a>Licensed under the Apache License, Version <span class="fl">2.0</span> (the <span class="st">"License"</span>);</span>
<span id="cb5-4"><a href="#cb5-4"></a>you may not use this file except <span class="cf">in</span> compliance with the License.</span>
<span id="cb5-5"><a href="#cb5-5"></a>You may obtain a copy of the License at </span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a>   http<span class="op">:</span><span class="er">//</span>www.apache.org<span class="op">/</span>licenses<span class="op">/</span>LICENSE<span class="fl">-2.0</span></span>
<span id="cb5-8"><a href="#cb5-8"></a></span>
<span id="cb5-9"><a href="#cb5-9"></a>Unless required by applicable law or agreed to <span class="cf">in</span> writing, software</span>
<span id="cb5-10"><a href="#cb5-10"></a>distributed under the License is distributed on an <span class="st">"AS IS"</span> BASIS,</span>
<span id="cb5-11"><a href="#cb5-11"></a>WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span id="cb5-12"><a href="#cb5-12"></a>See the License <span class="cf">for</span> the specific language governing permissions and</span>
<span id="cb5-13"><a href="#cb5-13"></a>limitations under the License.</span></code></pre></div>
</div>
</div>

  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small>Apache License (&gt;= 2.0)</small></li>
</ul>
</div>

<div class="community">
<h2 data-toc-skip>Community</h2>
<ul class="list-unstyled">
<li><a href="CONTRIBUTING.html">Contributing guide</a></li>
<li><a href="CODE_OF_CONDUCT.html">Code of conduct</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Evan Amies-Galonski <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/-3188" target="orcid.widget" aria-label="ORCID"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Joe Thorley <br><small class="roles"> Author </small> <a href="https://orcid.org/0000-0002-7683-4592" target="orcid.widget" aria-label="ORCID"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Province of British Columbia <br><small class="roles"> Copyright holder, funder </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://lifecycle.r-lib.org/articles/stages.html#stable" class="external-link"><img src="https://img.shields.io/badge/lifecycle-stable-brightgreen.svg" alt="Lifecycle: stable"></a></li>
<li><a href="https://github.com/poissonconsulting/nrp/actions" class="external-link"><img src="https://github.com/poissonconsulting/nrp/workflows/R-CMD-check/badge.svg" alt="R build status"></a></li>
<li><a href="https://codecov.io/gh/poissonconsulting/nrp?branch=master" class="external-link"><img src="https://codecov.io/gh/poissonconsulting/nrp/branch/master/graph/badge.svg" alt="Codecov test coverage"></a></li>
<li><a href="https://opensource.org/licenses/Apache-2.0" class="external-link"><img src="https://img.shields.io/badge/License-Apache%202.0-blue.svg" alt="Apache license"></a></li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Evan Amies-Galonski, Joe Thorley, Province of British Columbia.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 1.6.1.9001.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
